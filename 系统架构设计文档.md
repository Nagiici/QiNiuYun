# AI角色扮演平台 - 系统架构设计与开发规范文档

## 📋 目录
- [1. 系统概述](#1-系统概述)
- [2. 整体架构](#2-整体架构)
- [3. 技术栈详解](#3-技术栈详解)
- [4. 模块设计](#4-模块设计)
- [5. 数据库设计](#5-数据库设计)
- [6. API设计](#6-api设计)
- [7. 安全架构](#7-安全架构)
- [8. 性能优化](#8-性能优化)
- [9. 部署架构](#9-部署架构)
- [10. 模块规格与开发分工](#10-模块规格与开发分工)
- [11. 接口规范](#11-接口规范)
- [12. 开发流程](#12-开发流程)
- [13. 质量标准](#13-质量标准)

## 1. 系统概述

### 1.1 系统定位
AI角色扮演平台是一个全栈Web应用，提供智能AI角色创建、实时聊天交互、语音对话等功能，旨在为用户提供沉浸式的AI伙伴体验。

### 1.2 核心特性
- **智能角色系统**: 6维个性模型 + 角色背景设定
- **多AI提供商**: 支持Groq、OpenAI、Claude、Cohere、Ollama
- **实时通信**: WebSocket + HTTP RESTful API
- **语音交互**: 语音识别 + 文本转语音
- **响应式设计**: 支持桌面端和移动端

### 1.3 设计原则
- **模块化**: 高内聚、低耦合的模块设计
- **可扩展性**: 支持水平扩展和功能扩展
- **安全性**: 多层安全防护机制
- **性能**: 优化响应时间和用户体验
- **可维护性**: 清晰的代码结构和文档

## 2. 整体架构

### 2.1 系统架构图

```
┌─────────────────────────────────────────────────────────────┐
│                        用户界面层                             │
├─────────────────────────────────────────────────────────────┤
│  Vue 3 前端应用 (TypeScript + Vite)                        │
│  ├─ 页面组件 (Views)                                        │
│  ├─ 业务组件 (Components)                                   │
│  ├─ 状态管理 (Pinia Stores)                                │
│  └─ 工具函数 (Utils)                                        │
└─────────────────────────────────────────────────────────────┘
                              │
                        HTTP/WebSocket
                              │
┌─────────────────────────────────────────────────────────────┐
│                        API网关层                             │
├─────────────────────────────────────────────────────────────┤
│  Express.js 服务器                                          │
│  ├─ CORS 跨域处理                                          │
│  ├─ 请求限流 (Rate Limiting)                                │
│  ├─ 错误处理中间件                                          │
│  └─ 请求日志记录                                            │
└─────────────────────────────────────────────────────────────┘
                              │
                    ┌─────────┴─────────┐
                    │                   │
┌─────────────────────────────┐  ┌─────────────────────────────┐
│        业务逻辑层            │  │       WebSocket服务层        │
├─────────────────────────────┤  ├─────────────────────────────┤
│  RESTful API 路由           │  │  实时消息处理               │
│  ├─ 角色管理 (/characters)  │  │  ├─ 连接管理                │
│  ├─ 聊天管理 (/chats)       │  │  ├─ 消息广播                │
│  ├─ AI服务 (/ai)            │  │  ├─ 会话管理                │
│  └─ 系统配置 (/system)      │  │  └─ 主动聊天服务            │
└─────────────────────────────┘  └─────────────────────────────┘
                              │
┌─────────────────────────────────────────────────────────────┐
│                        服务层                               │
├─────────────────────────────────────────────────────────────┤
│  AI服务管理器                                               │
│  ├─ 多提供商管理 (Manager)                                  │
│  ├─ 提供商适配器 (Providers)                                │
│  ├─ 熔断器 (Circuit Breaker)                               │
│  ├─ 情感分析服务                                            │
│  └─ 语音服务集成                                            │
└─────────────────────────────────────────────────────────────┘
                              │
┌─────────────────────────────────────────────────────────────┐
│                        数据层                               │
├─────────────────────────────────────────────────────────────┤
│  SQLite 数据库                                              │
│  ├─ 用户角色表 (characters)                                 │
│  ├─ 聊天会话表 (chat_sessions)                              │
│  ├─ 消息记录表 (messages)                                   │
│  ├─ 系统配置表 (configurations)                             │
│  └─ 角色版本表 (character_versions)                         │
└─────────────────────────────────────────────────────────────┘
                              │
┌─────────────────────────────────────────────────────────────┐
│                      外部服务层                             │
├─────────────────────────────────────────────────────────────┤
│  AI提供商API                                                │
│  ├─ Groq (快速推理)                                         │
│  ├─ OpenAI (GPT模型)                                        │
│  ├─ Anthropic (Claude)                                      │
│  ├─ Cohere (对话优化)                                       │
│  └─ Ollama (本地部署)                                       │
│                                                             │
│  语音服务                                                   │
│  ├─ Web Speech API (浏览器原生)                             │
│  ├─ OpenAI Whisper (语音识别)                               │
│  └─ ElevenLabs (高质量TTS)                                  │
└─────────────────────────────────────────────────────────────┘
```

### 2.2 架构特点

#### **分层架构**
- **表现层**: Vue 3 + TypeScript，负责用户交互
- **网关层**: Express.js，负责请求路由和中间件处理
- **业务层**: 业务逻辑处理和数据验证
- **服务层**: AI服务集成和第三方API调用
- **数据层**: SQLite数据持久化

#### **微服务化设计**
- 角色管理服务
- 聊天服务
- AI智能服务
- WebSocket实时服务
- 文件上传服务

#### **事件驱动架构**
- WebSocket事件驱动的实时通信
- 主动聊天事件调度
- 用户行为事件追踪

## 3. 技术栈详解

### 3.1 前端技术栈

| 技术 | 版本 | 作用 | 选择理由 |
|------|------|------|----------|
| **Vue 3** | 3.4+ | 前端框架 | 渐进式框架，组合式API，性能优秀 |
| **TypeScript** | 5.2+ | 类型系统 | 类型安全，提升开发效率和代码质量 |
| **Vite** | 4.4+ | 构建工具 | 快速热重载，模块化构建 |
| **Pinia** | 2.1+ | 状态管理 | Vue 3官方推荐，类型友好 |
| **Vue Router** | 4.2+ | 路由管理 | 官方路由解决方案 |
| **TailwindCSS** | 3.3+ | CSS框架 | 实用优先，快速样式开发 |
| **DaisyUI** | 3.9+ | UI组件库 | 基于Tailwind的组件系统 |
| **Chart.js** | 4.4+ | 图表组件 | 个性雷达图展示 |
| **Axios** | 1.6+ | HTTP客户端 | Promise based，拦截器支持 |

### 3.2 后端技术栈

| 技术 | 版本 | 作用 | 选择理由 |
|------|------|------|----------|
| **Node.js** | 18+ | 运行时环境 | 异步I/O，生态丰富 |
| **Express.js** | 4.18+ | Web框架 | 轻量级，中间件丰富 |
| **TypeScript** | 5.2+ | 类型系统 | 全栈类型安全 |
| **SQLite** | 3.x | 数据库 | 轻量级，零配置，支持并发 |
| **WebSocket (ws)** | 8.14+ | 实时通信 | 低延迟双向通信 |
| **Multer** | 1.4+ | 文件上传 | Express文件上传中间件 |
| **Joi** | 18.0+ | 数据验证 | 强大的数据校验库 |
| **Opossum** | 9.0+ | 熔断器 | 服务降级和容错 |

### 3.3 开发工具

| 工具 | 作用 | 配置 |
|------|------|------|
| **tsx** | TypeScript执行器 | 开发环境热重载 |
| **Concurrently** | 并发脚本执行 | 同时启动前后端 |
| **dotenv** | 环境变量管理 | 配置文件加载 |
| **CORS** | 跨域处理 | 开发环境CORS配置 |

## 4. 模块设计

### 4.1 前端模块架构

```
client/src/
├── components/          # 可复用组件
│   ├── ChatSidebar.vue         # 聊天侧边栏
│   ├── ImageUpload.vue         # 图片上传组件
│   ├── LoadingSpinner.vue      # 加载动画
│   ├── PersonalityRadar.vue    # 个性雷达图
│   └── VirtualMessageList.vue  # 虚拟消息列表
│
├── views/               # 页面组件
│   ├── Home.vue                # 主页
│   ├── CreateCharacter.vue     # 角色创建页
│   ├── Chat.vue               # 聊天页面
│   └── Settings.vue           # 设置页面
│
├── stores/              # 状态管理
│   ├── characters.ts           # 角色状态管理
│   ├── chat.ts                # 聊天状态管理
│   └── global.ts              # 全局状态管理
│
├── services/            # 服务层
│   └── websocketService.ts    # WebSocket服务
│
├── utils/               # 工具函数
│   ├── api.ts                 # API封装
│   ├── constants.ts           # 常量定义
│   └── helpers.ts             # 辅助函数
│
├── composables/         # 组合式函数
│   ├── useAudio.ts            # 音频处理
│   ├── useChat.ts             # 聊天逻辑
│   └── useWebSocket.ts        # WebSocket封装
│
├── App.vue              # 根组件
├── main.ts             # 应用入口
└── style.css           # 全局样式
```

### 4.2 后端模块架构

```
server/src/
├── routes/              # 路由层
│   ├── characters.ts           # 角色管理路由
│   ├── chats.ts               # 聊天管理路由
│   ├── ai.ts                  # AI服务路由
│   ├── ai-new.ts              # 新AI服务路由
│   └── system.ts              # 系统配置路由
│
├── services/            # 服务层
│   ├── ai/                    # AI服务模块
│   │   ├── index.ts               # AI服务入口
│   │   ├── manager.ts             # AI服务管理器
│   │   ├── character.ts           # 角色AI服务
│   │   ├── emotion.ts             # 情感分析服务
│   │   ├── config.ts              # AI配置管理
│   │   └── providers/             # AI提供商适配器
│   │       ├── groq.ts               # Groq API适配器
│   │       ├── openai.ts             # OpenAI API适配器
│   │       ├── anthropic.ts          # Anthropic API适配器
│   │       ├── cohere.ts             # Cohere API适配器
│   │       └── ollama.ts             # Ollama API适配器
│   │
│   ├── websocketManager.ts    # WebSocket管理器
│   ├── proactiveChatService.ts # 主动聊天服务
│   └── circuitBreaker.ts      # 熔断器服务
│
├── database/            # 数据库层
│   ├── index.ts               # 数据库连接
│   ├── migrations.ts          # 数据库迁移
│   └── schemas.ts             # 数据库模式
│
├── middleware/          # 中间件
│   ├── rateLimiter.ts         # 限流中间件
│   ├── errorHandler.ts        # 错误处理中间件
│   ├── validation.ts          # 数据验证中间件
│   └── auth.ts                # 认证中间件(未来)
│
├── types/               # 类型定义
│   ├── character.ts           # 角色类型
│   ├── chat.ts                # 聊天类型
│   ├── ai.ts                  # AI服务类型
│   └── global.ts              # 全局类型
│
├── utils/               # 工具函数
│   ├── logger.ts              # 日志工具
│   ├── helpers.ts             # 辅助函数
│   └── constants.ts           # 常量定义
│
└── index.ts             # 应用入口
```

### 4.3 核心模块详解

#### **角色管理模块**
```typescript
// 角色服务接口
interface CharacterService {
  create(character: CreateCharacterRequest): Promise<Character>
  update(id: number, character: UpdateCharacterRequest): Promise<Character>
  delete(id: number): Promise<void>
  findById(id: number): Promise<Character | null>
  findAll(): Promise<Character[]>
  findByPersonality(traits: PersonalityTraits): Promise<Character[]>
}

// 角色数据模型
interface Character {
  id: number
  name: string
  description: string
  storyWorld?: string
  characterBackground?: string
  personalityData: PersonalityData
  personalityPreset?: string
  examples: ConversationExample[]
  avatar?: string
  createdAt: Date
  updatedAt: Date
}
```

#### **AI服务管理模块**
```typescript
// AI服务管理器
class AIServiceManager {
  private providers: Map<string, AIProvider>
  private circuitBreaker: CircuitBreaker

  async chat(request: ChatRequest): Promise<ChatResponse>
  async analyzeEmotion(text: string): Promise<EmotionAnalysis>
  async textToSpeech(text: string, options: TTSOptions): Promise<Buffer>
  async speechToText(audio: Buffer, options: STTOptions): Promise<string>
}

// AI提供商适配器接口
interface AIProvider {
  name: string
  isAvailable(): Promise<boolean>
  generateResponse(prompt: string, character: Character): Promise<string>
  getUsage(): ProviderUsage
}
```

#### **WebSocket通信模块**
```typescript
// WebSocket管理器
class WebSocketManager {
  private connections: Map<string, WebSocket>
  private rooms: Map<string, Set<string>>

  addConnection(userId: string, ws: WebSocket): void
  removeConnection(userId: string): void
  joinRoom(userId: string, roomId: string): void
  leaveRoom(userId: string, roomId: string): void
  broadcastToRoom(roomId: string, message: any): void
  sendToUser(userId: string, message: any): void
}
```

#### **状态管理模块**
```typescript
// 聊天状态存储
export const useChatStore = defineStore('chat', () => {
  const currentSession = ref<ChatSession | null>(null)
  const messages = ref<Message[]>([])
  const isConnected = ref(false)
  const isTyping = ref(false)

  const sendMessage = async (content: string) => { /* ... */ }
  const startVoiceRecording = () => { /* ... */ }
  const stopVoiceRecording = () => { /* ... */ }

  return {
    currentSession,
    messages,
    isConnected,
    isTyping,
    sendMessage,
    startVoiceRecording,
    stopVoiceRecording
  }
})
```

## 5. 数据库设计

### 5.1 数据库架构

```sql
-- 角色表
CREATE TABLE characters (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    name TEXT NOT NULL,
    description TEXT,
    story_world TEXT,
    character_background TEXT,
    has_mission BOOLEAN DEFAULT FALSE,
    current_mission TEXT,
    current_mood TEXT DEFAULT 'neutral',
    time_setting TEXT DEFAULT 'any',
    use_real_time BOOLEAN DEFAULT FALSE,
    personality_preset TEXT,
    personality_data TEXT, -- JSON格式的个性数据
    examples TEXT,         -- JSON格式的对话示例
    avatar TEXT,           -- 头像URL
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
);

-- 聊天会话表
CREATE TABLE chat_sessions (
    id TEXT PRIMARY KEY,
    character_id INTEGER,
    user_id TEXT,
    session_name TEXT,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (character_id) REFERENCES characters(id) ON DELETE CASCADE
);

-- 消息表
CREATE TABLE messages (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    session_id TEXT NOT NULL,
    character_id INTEGER,
    sender_type TEXT NOT NULL, -- 'user' 或 'character'
    content TEXT NOT NULL,
    message_type TEXT DEFAULT 'text', -- 'text', 'voice', 'image'
    metadata TEXT, -- JSON格式的元数据
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (session_id) REFERENCES chat_sessions(id) ON DELETE CASCADE,
    FOREIGN KEY (character_id) REFERENCES characters(id) ON DELETE CASCADE
);

-- 角色版本表（用于角色更新历史）
CREATE TABLE character_versions (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    character_id INTEGER NOT NULL,
    version_number INTEGER NOT NULL,
    character_data TEXT NOT NULL, -- JSON格式的完整角色数据
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (character_id) REFERENCES characters(id) ON DELETE CASCADE
);

-- 系统配置表
CREATE TABLE configurations (
    key TEXT PRIMARY KEY,
    value TEXT NOT NULL,
    description TEXT,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
);
```

### 5.2 数据关系图

```
characters (1) ←→ (N) chat_sessions (1) ←→ (N) messages
    ↓
character_versions (N)

configurations (独立表)
```

### 5.3 索引设计

```sql
-- 性能优化索引
CREATE INDEX idx_messages_session_id ON messages(session_id);
CREATE INDEX idx_messages_created_at ON messages(created_at);
CREATE INDEX idx_chat_sessions_character_id ON chat_sessions(character_id);
CREATE INDEX idx_character_versions_character_id ON character_versions(character_id);
```

## 6. API设计

### 6.1 RESTful API规范

#### **角色管理API**
```typescript
// GET /api/characters - 获取所有角色
// POST /api/characters - 创建新角色
// GET /api/characters/:id - 获取指定角色
// PUT /api/characters/:id - 更新角色
// DELETE /api/characters/:id - 删除角色

interface CreateCharacterRequest {
  name: string
  description: string
  storyWorld?: string
  characterBackground?: string
  personalityData: PersonalityData
  personalityPreset?: string
  examples: ConversationExample[]
}

interface CharacterResponse {
  id: number
  name: string
  description: string
  personalityData: PersonalityData
  avatar?: string
  createdAt: string
  updatedAt: string
}
```

#### **聊天管理API**
```typescript
// GET /api/chats/sessions - 获取聊天会话列表
// POST /api/chats/sessions - 创建新会话
// GET /api/chats/sessions/:id/messages - 获取会话消息
// DELETE /api/chats/sessions/:id - 删除会话

interface CreateSessionRequest {
  characterId: number
  sessionName?: string
}

interface SessionResponse {
  id: string
  characterId: number
  characterName: string
  sessionName: string
  lastMessage?: string
  createdAt: string
  updatedAt: string
}
```

#### **AI服务API**
```typescript
// POST /api/ai/chat - AI对话
// POST /api/ai/emotion - 情感分析
// POST /api/ai/tts - 文本转语音
// POST /api/ai/speech-to-text - 语音识别
// GET /api/ai/config - 获取AI配置
// POST /api/ai/config - 更新AI配置

interface ChatRequest {
  characterId?: number
  sessionId?: string
  message: string
  characterData?: Character // 用于临时角色
}

interface ChatResponse {
  response: string
  emotion?: EmotionAnalysis
  sessionId: string
  messageId: number
}
```

### 6.2 WebSocket API

#### **连接协议**
```typescript
// 连接URL: ws://localhost:8080/ws/{userId}/{roomId}

// 消息格式
interface WebSocketMessage {
  type: string
  data: any
  timestamp: number
  messageId?: string
}

// 消息类型
enum MessageType {
  CHAT_MESSAGE = 'chat_message',
  USER_TYPING = 'user_typing',
  USER_STOP_TYPING = 'user_stop_typing',
  JOIN_ROOM = 'join_room',
  LEAVE_ROOM = 'leave_room',
  SYSTEM_MESSAGE = 'system_message',
  ERROR = 'error'
}
```

#### **实时聊天流程**
```typescript
// 1. 客户端发送消息
{
  type: 'chat_message',
  data: {
    characterId: 1,
    sessionId: 'session-123',
    message: '你好！',
    messageType: 'text'
  }
}

// 2. 服务器响应
{
  type: 'chat_message',
  data: {
    messageId: 456,
    senderId: 'character-1',
    senderType: 'character',
    content: '你好！很高兴见到你！',
    emotion: { joy: 0.8, excitement: 0.6 }
  },
  timestamp: 1635724800000
}
```

## 7. 安全架构

### 7.1 多层安全防护

#### **网络层安全**
- HTTPS强制重定向
- CORS策略配置
- Rate Limiting限流
- DDoS防护（生产环境）

#### **应用层安全**
```typescript
// 输入验证中间件
const validateCharacterInput = (req: Request, res: Response, next: NextFunction) => {
  const schema = Joi.object({
    name: Joi.string().min(1).max(100).required(),
    description: Joi.string().max(1000),
    personalityData: Joi.object({
      energy: Joi.number().min(0).max(100),
      friendliness: Joi.number().min(0).max(100),
      // ...
    }).required()
  })

  const { error } = schema.validate(req.body)
  if (error) {
    return res.status(400).json({ error: error.details[0].message })
  }
  next()
}

// SQL注入防护（参数化查询）
const getUserCharacters = (userId: string) => {
  return db.all(
    'SELECT * FROM characters WHERE user_id = ?',
    [userId]
  )
}
```

#### **数据层安全**
- 敏感数据加密存储
- 数据库访问权限控制
- 定期数据备份
- 数据保留策略

### 7.2 API安全

#### **请求限流**
```typescript
// 分级限流策略
const characterLimiter = rateLimit({
  windowMs: 15 * 60 * 1000, // 15分钟
  max: 100, // 每15分钟最多100次请求
  message: '请求过于频繁，请稍后再试'
})

const aiChatLimiter = rateLimit({
  windowMs: 60 * 1000, // 1分钟
  max: 30, // 每分钟最多30次AI对话
  message: 'AI对话请求过于频繁'
})
```

#### **内容安全**
```typescript
// 内容过滤和清理
const sanitizeInput = (input: string): string => {
  return input
    .replace(/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi, '') // 移除脚本
    .replace(/javascript:/gi, '') // 移除JavaScript协议
    .trim()
    .substring(0, 5000) // 限制长度
}
```

## 8. 性能优化

### 8.1 前端性能优化

#### **代码分割和懒加载**
```typescript
// 路由级代码分割
const routes = [
  {
    path: '/',
    component: () => import('./views/Home.vue')
  },
  {
    path: '/chat',
    component: () => import('./views/Chat.vue')
  }
]

// 组件懒加载
const PersonalityRadar = defineAsyncComponent(() =>
  import('./components/PersonalityRadar.vue')
)
```

#### **虚拟滚动优化**
```typescript
// 长消息列表虚拟滚动
const VirtualMessageList = {
  setup() {
    const { list, containerProps, wrapperProps } = useVirtualList(
      messages,
      {
        itemHeight: 60,
        overscan: 5
      }
    )

    return { list, containerProps, wrapperProps }
  }
}
```

#### **状态管理优化**
```typescript
// 选择性状态订阅
const useChatMessages = () => {
  const chatStore = useChatStore()

  // 只订阅消息变化
  const messages = computed(() => chatStore.messages)

  // 避免不必要的重渲染
  const messageCount = computed(() => messages.value.length)

  return { messages, messageCount }
}
```

### 8.2 后端性能优化

#### **数据库优化**
```typescript
// 连接池配置
const dbConfig = {
  filename: './database.db',
  mode: sqlite3.OPEN_READWRITE | sqlite3.OPEN_CREATE,
  busyTimeout: 30000,
  pragma: {
    journal_mode: 'WAL',  // Write-Ahead Logging
    synchronous: 'NORMAL',
    temp_store: 'MEMORY',
    mmap_size: 268435456  // 256MB
  }
}

// 查询优化
const getRecentMessages = async (sessionId: string, limit: number = 50) => {
  return db.all(`
    SELECT m.*, c.name as character_name
    FROM messages m
    LEFT JOIN characters c ON m.character_id = c.id
    WHERE m.session_id = ?
    ORDER BY m.created_at DESC
    LIMIT ?
  `, [sessionId, limit])
}
```

#### **缓存策略**
```typescript
// 内存缓存
const NodeCache = require('node-cache')
const cache = new NodeCache({ stdTTL: 600 }) // 10分钟过期

const getCachedCharacter = async (id: number): Promise<Character | null> => {
  const cacheKey = `character:${id}`
  let character = cache.get<Character>(cacheKey)

  if (!character) {
    character = await fetchCharacterFromDB(id)
    if (character) {
      cache.set(cacheKey, character)
    }
  }

  return character
}
```

#### **AI服务优化**
```typescript
// 并发控制和熔断器
class AIProviderManager {
  private circuitBreaker = new CircuitBreaker(this.callAI.bind(this), {
    timeout: 15000,
    errorThresholdPercentage: 50,
    resetTimeout: 30000
  })

  async callAI(prompt: string): Promise<string> {
    // 尝试多个提供商，直到成功
    const providers = ['groq', 'openai', 'cohere']

    for (const provider of providers) {
      try {
        return await this.circuitBreaker.fire(prompt, provider)
      } catch (error) {
        console.warn(`Provider ${provider} failed:`, error.message)
        continue
      }
    }

    throw new Error('All AI providers unavailable')
  }
}
```

### 8.3 WebSocket性能优化

#### **连接管理**
```typescript
class WebSocketManager {
  private connections = new Map<string, WebSocket>()
  private rooms = new Map<string, Set<string>>()
  private heartbeatInterval = 30000

  // 心跳检测
  startHeartbeat(userId: string) {
    const interval = setInterval(() => {
      const ws = this.connections.get(userId)
      if (ws && ws.readyState === WebSocket.OPEN) {
        ws.ping()
      } else {
        this.removeConnection(userId)
        clearInterval(interval)
      }
    }, this.heartbeatInterval)
  }

  // 消息压缩
  broadcast(roomId: string, message: any) {
    const compressed = this.compressMessage(message)
    const room = this.rooms.get(roomId)

    if (room) {
      room.forEach(userId => {
        const ws = this.connections.get(userId)
        if (ws && ws.readyState === WebSocket.OPEN) {
          ws.send(compressed)
        }
      })
    }
  }
}
```

## 9. 部署架构

### 9.1 开发环境

```yaml
# docker-compose.dev.yml
version: '3.8'
services:
  frontend:
    build:
      context: ./client
      dockerfile: Dockerfile.dev
    ports:
      - "3000:3000"
    volumes:
      - ./client:/app
      - /app/node_modules
    environment:
      - VITE_API_BASE_URL=http://localhost:8080

  backend:
    build:
      context: ./server
      dockerfile: Dockerfile.dev
    ports:
      - "8080:8080"
    volumes:
      - ./server:/app
      - /app/node_modules
    environment:
      - NODE_ENV=development
      - PORT=8080
```

### 9.2 生产环境

#### **Docker化部署**
```dockerfile
# 前端 Dockerfile
FROM node:18-alpine AS builder
WORKDIR /app
COPY package*.json ./
RUN npm ci --only=production
COPY . .
RUN npm run build

FROM nginx:alpine
COPY --from=builder /app/dist /usr/share/nginx/html
COPY nginx.conf /etc/nginx/nginx.conf
EXPOSE 80

# 后端 Dockerfile
FROM node:18-alpine
WORKDIR /app
COPY package*.json ./
RUN npm ci --only=production
COPY . .
RUN npm run build
EXPOSE 8080
CMD ["npm", "start"]
```

#### **负载均衡配置**
```nginx
# nginx.conf
upstream backend {
    server backend1:8080;
    server backend2:8080;
    server backend3:8080;
}

server {
    listen 80;

    # 前端静态文件
    location / {
        root /usr/share/nginx/html;
        try_files $uri $uri/ /index.html;
    }

    # API代理
    location /api/ {
        proxy_pass http://backend;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
    }

    # WebSocket代理
    location /ws/ {
        proxy_pass http://backend;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "Upgrade";
        proxy_set_header Host $host;
    }
}
```

### 9.3 监控和日志

#### **应用监控**
```typescript
// 健康检查端点
app.get('/health', (req, res) => {
  res.json({
    status: 'OK',
    timestamp: new Date().toISOString(),
    uptime: process.uptime(),
    memory: process.memoryUsage(),
    database: db ? 'connected' : 'disconnected'
  })
})

// 性能指标收集
const collectMetrics = () => {
  return {
    activeConnections: wsManager.getConnectionCount(),
    totalSessions: sessionManager.getSessionCount(),
    aiRequestsPerMinute: aiService.getRequestRate(),
    errorRate: errorTracker.getErrorRate()
  }
}
```

#### **日志管理**
```typescript
// 结构化日志
const logger = winston.createLogger({
  level: 'info',
  format: winston.format.combine(
    winston.format.timestamp(),
    winston.format.errors({ stack: true }),
    winston.format.json()
  ),
  transports: [
    new winston.transports.File({ filename: 'error.log', level: 'error' }),
    new winston.transports.File({ filename: 'combined.log' }),
    new winston.transports.Console({
      format: winston.format.simple()
    })
  ]
})
```

## 10. 模块规格与开发分工

### 10.1 项目模块概览

#### **10.1.1 模块架构图**

```
AI角色扮演平台
├── 前端模块 (Client)
│   ├── 用户界面层 (UI Layer)
│   ├── 状态管理层 (State Layer)
│   ├── 服务层 (Service Layer)
│   └── 工具层 (Utils Layer)
│
├── 后端模块 (Server)
│   ├── 路由层 (Route Layer)
│   ├── 业务逻辑层 (Business Layer)
│   ├── 服务层 (Service Layer)
│   ├── 数据访问层 (Data Layer)
│   └── 中间件层 (Middleware Layer)
│
└── 共享模块 (Shared)
    ├── 类型定义 (Type Definitions)
    ├── 常量定义 (Constants)
    └── 工具函数 (Utils)
```

#### **10.1.2 技术栈分工**

| 层级 | 技术栈 | 主要职责 |  负责人 |
|------|--------|----------|--------------|
| **前端** | Vue 3 + TypeScript | 用户界面、交互逻辑 | 曹宏 |
| **后端** | Node.js + Express | API服务、业务逻辑 | 罗丹 |
| **数据库** | SQLite | 数据存储、查询优化 | 罗丹 |
| **AI集成** | 多提供商API | AI服务集成、优化 | 罗丹 |
| **实时通信** | WebSocket | 实时消息、状态同步 | 曹宏 |

### 10.2 前端模块规格

#### **10.2.1 主页模块 (Home.vue)**
```typescript
// 模块职责：用户入口、角色展示、导航功能
export interface HomePageModule {
  // 核心功能
  displayFeaturedCharacters(): Promise<Character[]>
  searchCharacters(query: string): Promise<Character[]>
  filterCharactersByPersonality(traits: PersonalityFilter): Promise<Character[]>
  navigateToCharacterChat(characterId: number): void
  navigateToCharacterCreation(): void

  // 状态管理
  featuredCharacters: Ref<Character[]>
  searchQuery: Ref<string>
  isLoading: Ref<boolean>
  currentFilter: Ref<PersonalityFilter>

  // 组件生命周期
  onMounted(): Promise<void>
  onUnmounted(): void
}
```

**开发任务清单：**
- [ ] 响应式布局设计与实现
- [ ] 角色卡片组件开发
- [ ] 搜索和筛选功能
- [ ] 加载状态和错误处理
- [ ] 移动端适配优化
- [ ] 性能优化（懒加载、虚拟滚动）

#### **10.2.2 角色创建模块 (CreateCharacter.vue)**
```typescript
// 模块职责：角色创建、编辑、预览
export interface CharacterCreationModule {
  // 表单管理
  characterForm: Ref<CharacterFormData>
  formValidation: ComputedRef<ValidationResult>

  // 个性系统
  personalityRadar: Ref<PersonalityData>
  personalityPresets: Ref<PersonalityPreset[]>

  // 文件上传
  avatarUpload: {
    uploadFile(file: File): Promise<string>
    previewImage: Ref<string | null>
    uploadProgress: Ref<number>
  }

  // 核心功能
  saveCharacter(): Promise<Character>
  previewCharacter(): void
  resetForm(): void
  loadCharacterForEdit(id: number): Promise<void>
}
```

**开发任务清单：**
- [ ] 多步骤表单设计
- [ ] 个性雷达图组件
- [ ] 文件上传组件
- [ ] 表单验证逻辑
- [ ] 角色预览功能
- [ ] 数据持久化

#### **10.2.3 聊天界面模块 (Chat.vue)**
```typescript
// 模块职责：实时聊天、语音交互、消息管理
export interface ChatInterfaceModule {
  // 消息管理
  messages: Ref<Message[]>
  currentSession: Ref<ChatSession | null>
  isTyping: Ref<boolean>

  // 语音功能
  voiceRecording: {
    isRecording: Ref<boolean>
    audioBlob: Ref<Blob | null>
    startRecording(): Promise<void>
    stopRecording(): Promise<string>  // 返回识别的文本
  }

  // 实时通信
  websocket: {
    isConnected: Ref<boolean>
    connect(sessionId: string): Promise<void>
    disconnect(): void
    sendMessage(content: string): void
    onMessageReceived(callback: (message: Message) => void): void
  }

  // 核心功能
  sendTextMessage(content: string): Promise<void>
  sendVoiceMessage(audioBlob: Blob): Promise<void>
  clearChatHistory(): Promise<void>
  exportChatHistory(): Promise<string>
}
```

**开发任务清单：**
- [ ] 消息列表虚拟滚动
- [ ] 语音录制与播放
- [ ] WebSocket连接管理
- [ ] 消息状态指示器
- [ ] 表情和富文本支持
- [ ] 聊天记录导出

### 10.3 后端模块规格

#### **10.3.1 角色管理路由 (characters.ts)**
```typescript
// 路由职责：角色CRUD API端点
export interface CharactersRouteModule {
  // API端点
  'GET /api/characters': () => Promise<Character[]>
  'POST /api/characters': (data: CreateCharacterRequest) => Promise<Character>
  'GET /api/characters/:id': (id: number) => Promise<Character>
  'PUT /api/characters/:id': (id: number, data: UpdateCharacterRequest) => Promise<Character>
  'DELETE /api/characters/:id': (id: number) => Promise<void>

  // 扩展端点
  'GET /api/characters/search': (query: string) => Promise<Character[]>
  'GET /api/characters/popular': () => Promise<Character[]>
  'POST /api/characters/:id/duplicate': (id: number) => Promise<Character>
}
```

**开发任务清单：**
- [ ] RESTful API端点实现
- [ ] 请求数据验证
- [ ] 错误处理中间件
- [ ] API文档生成
- [ ] 单元测试编写

#### **10.3.2 AI服务管理器 (ai/manager.ts)**
```typescript
// 服务职责：AI提供商管理和调度
export class AIServiceManager {
  private providers: Map<string, AIProvider>
  private circuitBreaker: CircuitBreaker
  private cache: NodeCache
  private config: AIConfiguration

  // 核心方法
  async generateResponse(request: ChatRequest): Promise<ChatResponse>
  async analyzeEmotion(text: string): Promise<EmotionAnalysis>
  async textToSpeech(text: string, options: TTSOptions): Promise<Buffer>
  async speechToText(audio: Buffer, options: STTOptions): Promise<string>
}
```

**开发任务清单：**
- [ ] 多提供商适配器实现
- [ ] 熔断器集成
- [ ] 缓存策略实现
- [ ] 负载均衡算法
- [ ] 使用量统计
- [ ] 错误恢复机制



## 10. 接口规范

### 10.1 前后端通信协议

#### **10.1.1 HTTP API规范**

**URL规范:**
```
https://api.domain.com/api/v1/{resource}/{id?}/{action?}

示例：
GET    /api/v1/characters           # 获取角色列表
POST   /api/v1/characters           # 创建角色
GET    /api/v1/characters/123       # 获取特定角色
PUT    /api/v1/characters/123       # 更新角色
DELETE /api/v1/characters/123       # 删除角色
POST   /api/v1/characters/123/chat  # 与角色对话
```

**请求格式:**
```typescript
// 标准请求头
interface RequestHeaders {
  'Content-Type': 'application/json'
  'Accept': 'application/json'
  'User-Agent': string
  'X-Request-ID': string  // 请求追踪ID
}

// 标准响应格式
interface ApiResponse<T = any> {
  success: true
  data: T
  metadata: {
    timestamp: number
    requestId: string
    executionTime: number
  }
}

// 错误响应
interface ApiError {
  success: false
  error: {
    code: string
    message: string
    details?: any
  }
  metadata: {
    timestamp: number
    requestId: string
  }
}
```

#### **11.1.2 WebSocket通信协议**

```typescript
// 基础消息结构
interface WebSocketMessage {
  type: MessageType
  data: any
  timestamp: number
  messageId?: string
  acknowledgment?: boolean  // 是否需要确认
}

// 消息类型枚举
enum MessageType {
  CHAT_MESSAGE = 'chat_message',
  USER_TYPING = 'user_typing',
  USER_STOP_TYPING = 'user_stop_typing',
  JOIN_ROOM = 'join_room',
  LEAVE_ROOM = 'leave_room',
  SYSTEM_MESSAGE = 'system_message',
  ERROR = 'error',
  HEARTBEAT = 'heartbeat'
}
```

### 10.2 数据模型规范

```typescript
// 角色实体
interface Character {
  id: number
  name: string
  description: string
  storyWorld?: string
  characterBackground?: string
  hasMission: boolean
  currentMission?: string
  currentMood: string
  timeSetting: string
  useRealTime: boolean
  personalityPreset?: string
  personalityData: PersonalityData
  examples: ConversationExample[]
  avatar?: string
  createdAt: Date
  updatedAt: Date
}

// 个性数据
interface PersonalityData {
  energy: number        // 能量 (0-100)
  friendliness: number  // 友好度 (0-100)
  humor: number         // 幽默感 (0-100)
  professionalism: number // 专业性 (0-100)
  creativity: number    // 创造力 (0-100)
  empathy: number       // 同理心 (0-100)
}

// 消息实体
interface Message {
  id: number
  sessionId: string
  characterId?: number
  senderId: string
  senderType: 'user' | 'character'
  content: string
  messageType: 'text' | 'voice' | 'image'
  emotion?: EmotionAnalysis
  metadata?: MessageMetadata
  createdAt: Date
}
```

## 11. 开发流程

### 11.1 Git工作流

#### **11.1.1 分支策略**

```
main (生产分支)
  ├── develop (开发分支)
  │   ├── feature/user-interface (功能分支)
  │   ├── feature/ai-integration
  │   ├── feature/voice-chat
  │   └── feature/real-time-chat
  │
  ├── release/v1.0 (发布分支)
  └── hotfix/critical-bug (热修复分支)
```

**分支命名规范:**
- `feature/功能名称`: 新功能开发
- `bugfix/问题描述`: Bug修复
- `hotfix/紧急修复`: 紧急修复
- `release/版本号`: 发布准备
- `experiment/实验名称`: 实验性功能

#### **11.1.2 提交规范**

```bash
# 提交消息格式
<type>(<scope>): <subject>

<body>

<footer>

# 示例
feat(chat): add voice message support

Add voice recording and playback functionality for chat messages.
- Implement voice recording with Web API
- Add audio playback controls
- Support voice message storage

Closes #123
```

**Type类型:**
- `feat`: 新功能
- `fix`: Bug修复
- `docs`: 文档更新
- `style`: 代码格式化
- `refactor`: 代码重构
- `test`: 测试相关
- `chore`: 构建/工具相关

### 11.2 代码质量标准

#### **11.2.1 TypeScript编码规范**

```typescript
// 命名约定
interface UserPreferences {  // 接口：PascalCase
  themeMode: 'light' | 'dark'  // 属性：camelCase
  fontSize: number
}

class CharacterService {  // 类：PascalCase
  private apiClient: ApiClient  // 私有成员：camelCase前缀

  public async createCharacter(  // 方法：camelCase
    characterData: CreateCharacterRequest  // 参数：camelCase
  ): Promise<Character> {
    // 实现
  }
}

const API_BASE_URL = 'https://api.example.com'  // 常量：SCREAMING_SNAKE_CASE
```

### 11.3 测试策略

#### **11.3.1 单元测试**

```typescript
// 前端组件测试 (Vitest + Vue Test Utils)
import { mount } from '@vue/test-utils'
import { describe, it, expect } from 'vitest'
import CharacterCard from './CharacterCard.vue'

describe('CharacterCard', () => {
  const mockCharacter = {
    id: 1,
    name: 'Test Character',
    description: 'A test character',
    personalityData: {
      energy: 80,
      friendliness: 70,
      humor: 60,
      professionalism: 50,
      creativity: 90,
      empathy: 85
    }
  }

  it('renders character information correctly', () => {
    const wrapper = mount(CharacterCard, {
      props: { character: mockCharacter }
    })

    expect(wrapper.text()).toContain('Test Character')
    expect(wrapper.text()).toContain('A test character')
  })
})
```

## 12. 质量标准

### 12.1 性能要求

#### **12.1.1 前端性能指标**

| 指标 | 目标值 | 测量方法 |
|------|--------|----------|
| **首次内容绘制 (FCP)** | < 1.5s | Lighthouse |
| **最大内容绘制 (LCP)** | < 2.5s | Web Vitals |
| **首次输入延迟 (FID)** | < 100ms | Real User Monitoring |
| **累积布局偏移 (CLS)** | < 0.1 | Web Vitals |
| **交互到下次绘制 (INP)** | < 200ms | Web Vitals |

#### **12.1.2 后端性能指标**

| 指标 | 目标值 | 测量方法 |
|------|--------|----------|
| **API响应时间** | < 500ms (95%) | APM工具 |
| **AI对话生成** | < 5s | 自定义监控 |
| **WebSocket延迟** | < 100ms | 网络监控 |
| **数据库查询** | < 100ms (95%) | 查询分析器 |
| **并发连接** | 1000+ | 负载测试 |

### 12.2 代码质量指标

#### **12.2.1 静态代码分析**

```json
// .eslintrc.js
module.exports = {
  extends: [
    '@vue/typescript/recommended',
    '@vue/prettier',
    '@vue/prettier/@typescript-eslint'
  ],
  rules: {
    'complexity': ['error', 10],        // 圈复杂度 < 10
    'max-lines': ['error', 300],        // 文件行数 < 300
    'max-lines-per-function': ['error', 50], // 函数行数 < 50
    'max-params': ['error', 4],         // 参数个数 < 4
    'max-depth': ['error', 4],          // 嵌套深度 < 4
    'no-console': 'warn',               // 禁用console
    'no-debugger': 'error'              // 禁用debugger
  }
}
```

#### **12.2.2 测试覆盖率要求**

| 类型 | 覆盖率要求 | 工具 |
|------|------------|------|
| **单元测试** | > 80% | Vitest, Jest |
| **集成测试** | > 60% | Cypress, Playwright |
| **API测试** | > 90% | Supertest |
| **端到端测试** | > 50% | Cypress |

### 12.3 安全标准

#### **12.3.1 安全检查清单**

```typescript
// 安全中间件示例
const securityMiddleware = [
  helmet(),                    // 安全头部
  rateLimit({                 // 请求限流
    windowMs: 15 * 60 * 1000,
    max: 100
  }),
  cors({                      // CORS配置
    origin: process.env.ALLOWED_ORIGINS?.split(','),
    credentials: true
  }),
  express.json({ limit: '10mb' }), // 请求体大小限制
  sanitizeInput,              // 输入清理
  validateJWT                 // JWT验证（未来）
]

// 输入验证示例
const characterValidation = Joi.object({
  name: Joi.string().min(1).max(100).required(),
  description: Joi.string().max(1000),
  personalityData: Joi.object({
    energy: Joi.number().min(0).max(100).required(),
    friendliness: Joi.number().min(0).max(100).required(),
    humor: Joi.number().min(0).max(100).required(),
    professionalism: Joi.number().min(0).max(100).required(),
    creativity: Joi.number().min(0).max(100).required(),
    empathy: Joi.number().min(0).max(100).required()
  }).required()
})
```

---

## 总结

本架构设计与开发规范文档提供了AI角色扮演平台的完整技术架构方案和开发指导，包括：

1. **清晰的分层架构**：前端、网关、业务、服务、数据层分离
2. **模块化设计**：高内聚、低耦合的模块划分
3. **详细的开发规范**：模块规格、接口标准、开发流程
4. **明确的分工安排**：团队角色和开发任务分配
5. **严格的质量要求**：性能、安全、可维护性标准
6. **完整的开发流程**：从设计到部署的全流程管理

该架构支持高并发访问、水平扩展，并为团队协作和项目管理提供了完整的指导框架。
